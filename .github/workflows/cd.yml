name: Frontend CD

on:
   push:
      branches:
         - "main"
         - "dev-branch"
         - "cont-dep"

   workflow_run:
      workflows: ["Frontend CI"]
      types:
         - completed

jobs:
   deploy:
      if: ${{ github.event.workflow_run.conclusion == 'success' }}
      runs-on: ubuntu-latest

      permissions:
         contents: read
         packages: write

      steps:
         - name: Checkout Code
           uses: actions/checkout@v4

         - name: Log in to GitHub Container Registry
           uses: docker/login-action@v3
           with:
              registry: ghcr.io
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}

         - name: Build and Push Docker Image
           uses: docker/build-push-action@v5
           with:
              context: .
              push: true
              tags: ghcr.io/${{ github.repository_owner }}/salamander-frontend:latest

         - name: Deploy to DigitalOcean Droplet
           uses: appleboy/ssh-action@v1.0.3
           with:
              host: ${{ secrets.DO_HOST }}
              username: ${{ secrets.DO_USERNAME }}
              key: ${{ secrets.DO_SSH_KEY }}
              script: |
                 echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

                 docker stop frontend || true
                 docker rm frontend || true

                 docker pull ghcr.io/${{ github.repository_owner }}/salamander-frontend:latest

                 docker run -d \
                   --name frontend \
                   --restart unless-stopped \
                   -p 80:3000 \
                   ghcr.io/${{ github.repository_owner }}/salamander-frontend:latest
